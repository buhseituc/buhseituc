(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([[12],{"25bd":function(t,e,i){"use strict";i.r(e);var s=function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("q-page",{staticClass:"flex flex-start"},[i("div",{staticClass:"fullscreen"},[i("div",{staticClass:"fit"},[i("q-carousel",{staticClass:"fit bg-dark text-white",attrs:{"keep-alive":!0,"keep-alive-max":10,vertical:t.vertical,"transition-prev":t.slidePrevTransition,"transition-next":t.slideNextTransition,swipeable:"",animated:"",arrows:"","control-color":"mask-white","control-type":"regular"},on:{transition:t.afterEnterSlide},model:{value:t.slideName,callback:function(e){t.slideName=e},expression:"slideName"}},t._l(t.previewItems,(function(e){return i("q-carousel-slide",{key:e.hash_id,staticClass:"slide-container column no-wrap flex-center q-pa-none",attrs:{name:e.hash_id}},[t.checkItemHasClip(e)?i("video",{ref:"video-player-"+e.hash_id,refInFor:!0,attrs:{id:"video-player-"+e.hash_id,playsinline:"",controls:""}}):i("div",{staticClass:"row fit justify-start items-center"},[i("q-img",{staticStyle:{"max-height":"100%"},attrs:{src:t.getRandomCover(e)}})],1),e.title?i("div",{staticClass:"q-pa-sm absolute-top bg-mask text-mask text-center",style:t.titleStyleObj},[i("div",{staticClass:"ellipsis-2-lines text-h6 text-weight-medium",staticStyle:{"word-break":"break-all"}},[t._v("\n              "+t._s(e.title)+"\n            ")])]):t._e()])})),1)],1),t.isPlayerLoading?i("div",{staticClass:"q-pa-md fixed-center no-pointer-events"},[i("q-circular-progress",{attrs:{indeterminate:"",size:"md",color:"primary"}})],1):t._e(),i("q-page-sticky",{attrs:{position:"top-right",offset:[12,14]}},[i("q-btn",{attrs:{round:"",icon:"close",color:"mask-white",padding:"5px"},on:{click:t.exitPreview}})],1),i("q-page-sticky",{attrs:{position:this.vertical?"bottom-right":"top-left",offset:[12,14]}},[i("div",{staticClass:"column items-center q-gutter-y-md"},[i("q-fab",{attrs:{color:"mask-white",icon:"menu","active-icon":"minimize",direction:this.vertical?"up":"down",padding:"5px"},model:{value:t.showFabActions,callback:function(e){t.showFabActions=e},expression:"showFabActions"}},[i("q-fab-action",{attrs:{color:t.favoriteIconColor,"text-color":t.favoriteIconColor,icon:t.favoriteIcon,padding:"5px"},on:{click:t.toggleFavorite}}),i("q-fab-action",{attrs:{color:"mask-white","text-color":"orange",icon:"play_arrow",padding:"5px"},on:{click:t.launchDetail}})],1)],1)])],1)])},r=[],a=(i("ddb0"),i("e6cf"),i("5319"),i("ca79")),o=i.n(a);window.previewPlyrInsts={};var n={name:"Preview",data(){return{previewItems:{},fetchedItems:[],unwatchedHashIds:[],slideName:void 0,iconUrl:"https://cdn.jsdelivr.net/npm/plyr@3.6.3/dist/plyr.svg",blankVideo:"https://cdn.jsdelivr.net/npm/plyr@3.6.3/dist/blank.mp4",isPlayerMuted:!0,isPlayerControlsShown:!1,isPlayerLoading:!1,isFavoriteCache:{},isFavorite:!1,favoriteIconDefault:"favorite_border",favoriteIconActive:"favorite",favoriteIconColorDefault:"mask-white",favoriteIconColorActive:"mask-red-8",showFabActions:!0}},computed:{username(){const t=this.$store.state.api.userAccount||{};return t.username||this.$t("Guest")},vertical(){return this.$q.screen.height>=this.$q.screen.width},slidePrevTransition(){return this.vertical?"slide-down":"slide-right"},slideNextTransition(){return this.vertical?"slide-up":"slide-left"},currentItem(){return this.previewItems[this.slideName]||{}},currentHasClip(){return this.checkItemHasClip(this.currentItem)},titleStyleObj(){return{opacity:this.isPlayerControlsShown?.3:this.currentHasClip?0:.3}},favoriteIcon(){return this.isFavorite?this.favoriteIconActive:this.favoriteIconDefault},favoriteIconColor(){return this.isFavorite?this.favoriteIconColorActive:this.favoriteIconColorDefault}},created(){this.processGetPreviewItems().then((t=>{const e=t[0]||{};this.slideName=e.hash_id||void 0})).catch((t=>{const e=JSON.stringify(t);console.log(`Process failed: ${e}`)}))},mounted(){this.initFavorite(),this.initPlayer(),this.$gtag.event("enter_preview",{event_category:"enter_page",event_label:this.username})},beforeRouteLeave(t,e,i){Object.entries(window.previewPlyrInsts).forEach((([t,e])=>{e instanceof o.a&&e.destroy(),delete window.previewPlyrInsts[t]})),i()},methods:{async processGetPreviewItems(){const t=await this.$apc.authApi("video_item/getpreviewitems");return this.fetchedItems=t.list||[],this.$apc.utils.shuffleArray(this.fetchedItems),this.fetchedItems.forEach(((t,e)=>{this.unwatchedHashIds.push(t.hash_id),this.$set(this.previewItems,t.hash_id,t)})),this.fetchedItems},getItemMeta(t){return t.meta||{}},getItemWidth(t){const e=this.getItemMeta(t),i=!e.width||e.width<1?640:e.width;return i},getItemHeight(t){const e=this.getItemMeta(t),i=!e.height||e.height<1?360:e.height;return i},getItemRatio(t){return this.getItemWidth(t)/this.getItemHeight(t)},checkItemIsPortrait(t){return this.getItemHeight(t)>this.getItemWidth(t)},getRandomCover(t){const e=this.getItemMeta(t),i=e.cover_full_urls||[];let s;return s=i.length<1?this.checkItemIsPortrait(t)?"images/cover-portrait.jpg":"images/cover-landscape.jpg":i[Math.floor(Math.random()*i.length)],s},getRandomClip(t){const e=this.getItemMeta(t),i=e.clip_full_urls||[];let s;return i.length>0&&(s=i[Math.floor(Math.random()*i.length)]),s},checkItemHasClip(t){return!!this.getRandomClip(t)},playerConfig(){const t={iconUrl:this.iconUrl,blankVideo:this.blankVideo,muted:!0,resetOnEnd:!0,loop:{active:!0},controls(){const t=["play-large","play","progress","current-time","duration","mute","volume"];return t}};return t},getPlyrInstKey(t){if(void 0!==t)return t},getCurrentPlyrInstKey(){return this.getPlyrInstKey(this.slideName)},initPlayer(){const t=this.getCurrentPlyrInstKey(),e=this.getRandomClip(this.currentItem);if(!t||!e)return;const i=window.previewPlyrInsts[t];if(i instanceof o.a)return i;const s=new o.a("#video-player-"+t,this.playerConfig());return s.on("volumechange",(t=>{const e=t.detail.plyr;this.isPlayerMuted=e.muted})),s.on("controlsshown",(t=>{this.isPlayerControlsShown=!0})),s.on("controlshidden",(t=>{this.isPlayerControlsShown=!1})),s.on("seeking",(t=>{this.isPlayerLoading=!0})),s.on("seeked",(t=>{this.isPlayerLoading=!1})),s.on("loadstart",(t=>{this.isPlayerLoading=!0})),s.on("loadeddata",(t=>{this.isPlayerLoading=!1})),s.on("ended",(t=>{const e=t.detail.plyr;e.play()})),window.previewPlyrInsts[t]=s,this.setPlayerSource(this.slideName,e),window.previewPlyrInsts[t]},setPlayerSource(t,e){const i=this.getPlyrInstKey(t);if(!i)return;const s=window.previewPlyrInsts[i];if(!(s instanceof o.a))return;let r;if("object"!==typeof e||e instanceof Event){const t=e||this.blankVideo;r={type:"video",sources:[{src:t,type:"video/mp4"}]}}else r=e;return s.source=r,s},getPlayer(t){return window.previewPlyrInsts[this.getPlyrInstKey(t)]},getCurrentPlayer(){return this.getPlayer(this.slideName)},afterEnterSlide(t,e){if(this.initFavorite(),this.initPlayer(),this.unwatchedHashIds.includes(this.slideName)&&(this.unwatchedHashIds=this.unwatchedHashIds.filter((t=>t!==this.slideName))),this.unwatchedHashIds.length<2&&this.processGetPreviewItems().catch((t=>{const e=JSON.stringify(t);console.log(`Process failed: ${e}`)})),this.getCurrentPlayer()){if(!this.getCurrentPlayer().playing){const t=this.getCurrentPlayer().play();t&&t.catch((t=>{console.log("Player is waiting")}))}this.getCurrentPlayer().muted=this.isPlayerMuted}},initFavorite(){const t=this.currentItem.hash_id;t&&(void 0===this.isFavoriteCache[t]?this.$apc.authApi("video_favorite/isfavorite",{hash_id:t}).then((e=>{this.isFavorite=!!e.is_favorite,this.isFavoriteCache[t]=this.isFavorite})).catch((t=>{const e=JSON.stringify(t);console.log(`Process failed: ${e}`)})):this.isFavorite=!!this.isFavoriteCache[t])},toggleFavorite(){this.showFabActions=!0;const t=this.currentItem.hash_id;if(!t)return;const e=this.isFavorite?this.$t("Unfavorite successfully"):this.$t("Add to favorites successfully"),i=this.isFavorite?"favorite_border":"favorite",s=this.$q.platform.is.mobile?"center":"top-right",r=this.isFavorite?"video_favorite/remove":"video_favorite/add";this.$apc.authApi(r,{hash_id:t}).then((r=>{this.$apc.notifySuccess(e,s,1500,i),this.isFavorite=!this.isFavorite,this.isFavoriteCache[t]=this.isFavorite})).catch((t=>{const e=JSON.stringify(t);console.log(`Process failed: ${e}`)}))},launchDetail(){this.showFabActions=!0;const t=this.currentItem.hash_id;t&&this.$router.push({name:"detail",params:{itemId:t}}).catch((t=>{console.log(t)}))},exitPreview(){window.history.length>2?this.$router.go(-1):this.$router.replace("/").catch((t=>{console.log(t)}))}}},l=n,c=i("2877"),h=i("9989"),d=i("880c"),u=i("62cd"),v=i("068f"),m=i("58ea"),p=i("de5e"),g=i("9c40"),f=i("c294"),y=i("72db"),w=i("eebe"),I=i.n(w),P=Object(c["a"])(l,s,r,!1,null,null,null);e["default"]=P.exports;I()(P,"components",{QPage:h["a"],QCarousel:d["a"],QCarouselSlide:u["a"],QImg:v["a"],QCircularProgress:m["a"],QPageSticky:p["a"],QBtn:g["a"],QFab:f["a"],QFabAction:y["a"]})}}]);